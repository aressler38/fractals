<!doctype html5>
<html>
<head>
    <title>Mandelbrot Set</title>
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: auto;
            height: auto;
        }
        button {
            position: relative;
            padding: 1ex;
            z-index: 1000;
        }
    </style>
    <script src="../lib/require.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            require(["../HardWorker/HardWorker", "mandelbrot"], function(HardWorker, Mandelbrot) {
                var canvas = document.getElementById("canvas");
                var context = canvas.getContext("2d");
                var hw = new HardWorker({url:"../HardWorker/mainHardWorker.js"});
                var now = function () { return window.performance.now(); };
                var t = now();

                hw.loadScript("lib/require.js", function() {
                    hw.loadModule({
                        path: "../mandelbrot/mandelbrot.js", 
                        trigger:"mandelbrot"
                    }, buildImage, main);
                });

                function main() {
//                    getMandelbrot();
                    window.hw = hw;
                }

                function getMandelbrot(width, height) {
                    width = (width) ? width : 800;
                    height = (height) ? height : 600;
                    console.log("generating Mandelbrot!");
                    t=now();
                    canvas.setAttribute("width", width);
                    canvas.setAttribute("height", height);
                    hw.trigger("mandelbrot", {
                        width: width,
                        height: height
                    });
                }

                function buildImage(data) {
                    var bytes = new Uint8Array(data.buffer);
                    var image = context.createImageData(canvas.width, canvas.height);
                    for (var i=0; i<bytes.length; i++) {
                        image.data[i] = bytes[i];
                    }
                    context.putImageData(image, 0, 0);
                    var deltaT = (now() - t) / 1000;
                    console.log('built bit map in '+(deltaT).toFixed(2)+'s');
                    console.log("Iteration Count: "+(data.iterations).toExponential());
                    var calculations = 19*data.iterations;
                    console.log("Number of calculations estimate: "+calculations.toExponential());
                    console.log("calculations/second ratio: "+(calculations/deltaT).toExponential());
                }

                function getMandelbrotSlow(width, height) {
                    width = (width) ? width : 800;
                    height = (height) ? height : 600;
                    console.log("generating Mandelbrot! (in main thread)");
                    t=now();
                    canvas.setAttribute("width", width);
                    canvas.setAttribute("height", height);
                    var data = Mandelbrot({
                        width: width,
                        height: height
                    });
                    buildImage(data);
                }

                window.getMandelbrot = getMandelbrot;
                window.getMandelbrotSlow = getMandelbrotSlow;
            });
            
        });
    </script>
</head>
<body>
    <button onclick="window.getMandelbrot();">draw via HardWorker</button>
    <button onclick="window.getMandelbrotSlow();">draw in Main Thread (Warning: Locks UI!)</button>
    <canvas id="canvas"></canvas>
</body>
</html>
